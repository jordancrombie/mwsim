# iOS Build & TestFlight Upload Pipeline
# Triggers on push to main branch or manual dispatch
#
# Prerequisites (GitHub Secrets required):
#   APPLE_API_KEY_ID        - App Store Connect API Key ID (e.g., 649V537DQX)
#   APPLE_API_ISSUER_ID     - App Store Connect API Issuer ID
#   APPLE_API_KEY_BASE64    - Base64-encoded .p8 API key file
#   APPLE_TEAM_ID           - Apple Developer Team ID (e.g., ZJHD6JAC94)
#   MATCH_PASSWORD          - Password for match certificates (if using fastlane match)
#   KEYCHAIN_PASSWORD       - Temporary keychain password

name: iOS Build & TestFlight

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - '.github/workflows/ios-build.yml'
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number (leave empty to auto-increment)'
        required: false
        type: string

env:
  NODE_VERSION: '20'
  XCODE_VERSION: '16.2'
  BUNDLE_ID: 'com.banksim.wsim'

jobs:
  build-ios:
    name: Build iOS & Upload to TestFlight
    runs-on: macos-14  # M1 Mac runner
    timeout-minutes: 45

    steps:
      # ============================================
      # 1. CHECKOUT & SETUP
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      # ============================================
      # 2. INSTALL DEPENDENCIES
      # ============================================
      - name: Install npm dependencies
        working-directory: app
        run: npm ci

      # ============================================
      # 3. VERSION BUMP (optional)
      # ============================================
      - name: Get current build number
        id: get-build
        working-directory: app
        run: |
          CURRENT_BUILD=$(jq -r '.expo.ios.buildNumber' app.json)
          VERSION=$(jq -r '.expo.version' app.json)
          echo "current_build=$CURRENT_BUILD" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Calculate new build number
        id: new-build
        run: |
          if [ -n "${{ github.event.inputs.build_number }}" ]; then
            NEW_BUILD="${{ github.event.inputs.build_number }}"
          else
            NEW_BUILD=$((${{ steps.get-build.outputs.current_build }} + 1))
          fi
          echo "build_number=$NEW_BUILD" >> $GITHUB_OUTPUT

      - name: Update build number in app.json
        working-directory: app
        run: |
          jq '.expo.ios.buildNumber = "${{ steps.new-build.outputs.build_number }}"' app.json > tmp.json
          mv tmp.json app.json
          echo "Updated build number to ${{ steps.new-build.outputs.build_number }}"

      # ============================================
      # 4. EXPO PREBUILD
      # ============================================
      - name: Run Expo prebuild
        working-directory: app
        run: npx expo prebuild --clean --platform ios

      # ============================================
      # 5. SETUP CODE SIGNING
      # ============================================
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APPLE_API_KEY_BASE64 }}" | base64 --decode > ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8

      - name: Create temporary keychain
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      # ============================================
      # 6. BUILD ARCHIVE
      # ============================================
      - name: Build iOS Archive
        working-directory: app/ios
        run: |
          xcodebuild \
            -workspace mwsim.xcworkspace \
            -scheme mwsim \
            -configuration Release \
            -archivePath ${{ runner.temp }}/mwsim.xcarchive \
            archive \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APPLE_API_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APPLE_API_ISSUER_ID }}

      # ============================================
      # 7. EXPORT IPA
      # ============================================
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath ${{ runner.temp }}/mwsim.xcarchive \
            -exportPath ${{ runner.temp }}/export \
            -exportOptionsPlist app/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APPLE_API_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APPLE_API_ISSUER_ID }}

      # ============================================
      # 8. UPLOAD TO TESTFLIGHT
      # ============================================
      - name: Upload to TestFlight
        run: |
          xcrun altool --upload-app --type ios \
            --file ${{ runner.temp }}/export/mwsim.ipa \
            --apiKey ${{ secrets.APPLE_API_KEY_ID }} \
            --apiIssuer ${{ secrets.APPLE_API_ISSUER_ID }}

      # ============================================
      # 9. CLEANUP & ARTIFACTS
      # ============================================
      - name: Upload IPA as artifact
        uses: actions/upload-artifact@v4
        with:
          name: mwsim-${{ steps.get-build.outputs.version }}-${{ steps.new-build.outputs.build_number }}
          path: ${{ runner.temp }}/export/mwsim.ipa
          retention-days: 30

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f ~/.private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8 || true

      # ============================================
      # 10. SUMMARY
      # ============================================
      - name: Build Summary
        run: |
          echo "## iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.get-build.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.new-build.outputs.build_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle ID | ${{ env.BUNDLE_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Uploaded to TestFlight |" >> $GITHUB_STEP_SUMMARY
